<!DOCTYPE html>
<style>

body{
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  
	-webkit-font-smoothing:antialiased;
  
  font-weight:300;
  font-family:Helvetica;
  
  text-align:center;
}

.header{
  background:rgb(0,188,212);
  
  padding:20px;
  
  text-align:left;
  
  position:relative;
}
.header:after{
  visibility:hidden;
  display:block;
  font-size:0;
  content:' ';
  clear:both;
  height:0;
}
.header .timer{
  float:right;
  
  display:block;
  vertical-align:middle;
  
  border:4px dashed rgba(255,255,255,0.75);
	-webkit-border-radius: 3px;
	-moz-border-radius:    3px;
	border-radius:         3px;
  
  color:rgb(255,255,255);
  
  font-size:30px;
  font-weight:700;
  
  padding:12px 26px;
  min-width:70px;
  
  text-align:center;
}
.header .menu{
  position:absolute;
  left:20px;
  top:50%;
  
  -webkit-transform:translate(0, -50%);
  -moz-transform:   translate(0, -50%);
  -mos-transform:   translate(0, -50%);
  -o-transform:     translate(0, -50%);
  transform:        translate(0, -50%);
  
  background:transparent center center no-repeat;
  background-size:48px 48px;
  background-image:url(/images/hamburger.svg);
  
  width: 48px;
  height:48px;
  
  cursor:pointer;
}

.board{
  margin:50px;
}

square\:dest{
  display:inline-block;
  
  vertical-align:middle;
  
  box-shadow:inset 1px 1px 0px 1px rgb(210,210,210);
  background:rgb(230,230,230);
  
	-webkit-border-radius: 3px;
	-moz-border-radius:    3px;
	border-radius:         3px;
  overflow:hidden;
  
  margin:6px;
  
  cursor:default;
}
square\:dest square,
square\:moving{
  display:block;
  
  background:rgb(232,48,108);
  color:rgb(255,255,255);
  
  height:100%;
  width:100%;
  
  font-family:Arial;
  font-size:30px;
  font-weight:700;
  text-align:center;
  text-transform:uppercase;
  
  cursor:move;
}
square\:dest square.moving{
  display:none;
}
square\:dest square.locked{
  cursor:not-allowed;
  
  background:rgb(146,160,160);
}
square\:dest,
square\:moving{
  height:     80px;
  width:      80px;
  line-height:80px;
}
square\:moving{
  position:absolute;
  
  z-index:999;
  
	-webkit-border-radius: 3px;
	-moz-border-radius:    3px;
	border-radius:         3px;

  -webkit-animation: animation 1000ms linear both;
  animation:         animation 1000ms linear both;
}

/* Bounce.js */
@keyframes animation{
  0%{
    box-shadow:0 0 0 transparent;
    -webkit-transform:matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);
  }
  3.4%{
    -webkit-transform:matrix3d(1.095,0,0,0,0,1.122,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.095,0,0,0,0,1.122,0,0,0,0,1,0,0,0,0,1);
  }
  4.7%{
    -webkit-transform:matrix3d(1.135,0,0,0,0,1.18,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.135,0,0,0,0,1.18,0,0,0,0,1,0,0,0,0,1);
  }
  6.81%{
    -webkit-transform:matrix3d(1.198,0,0,0,0,1.268,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.198,0,0,0,0,1.268,0,0,0,0,1,0,0,0,0,1);
  }
  9.41%{
    -webkit-transform:matrix3d(1.265,0,0,0,0,1.35,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.265,0,0,0,0,1.35,0,0,0,0,1,0,0,0,0,1);
  }
  10.21%{
    -webkit-transform:matrix3d(1.282,0,0,0,0,1.368,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.282,0,0,0,0,1.368,0,0,0,0,1,0,0,0,0,1);
  }
  13.61%{
    -webkit-transform:matrix3d(1.337,0,0,0,0,1.4,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.337,0,0,0,0,1.4,0,0,0,0,1,0,0,0,0,1);
  }
  14.11%{
    -webkit-transform:matrix3d(1.342,0,0,0,0,1.399,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.342,0,0,0,0,1.399,0,0,0,0,1,0,0,0,0,1);
  }
  17.52%{
    -webkit-transform:matrix3d(1.362,0,0,0,0,1.372,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.362,0,0,0,0,1.372,0,0,0,0,1,0,0,0,0,1);
  }
  18.72%{
    -webkit-transform:matrix3d(1.364,0,0,0,0,1.356,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.364,0,0,0,0,1.356,0,0,0,0,1,0,0,0,0,1);
  }
  21.32%{
    -webkit-transform:matrix3d(1.359,0,0,0,0,1.321,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.359,0,0,0,0,1.321,0,0,0,0,1,0,0,0,0,1);
  }
  24.32%{
    -webkit-transform:matrix3d(1.345,0,0,0,0,1.288,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.345,0,0,0,0,1.288,0,0,0,0,1,0,0,0,0,1);
  }
  25.23%{
    -webkit-transform:matrix3d(1.34,0,0,0,0,1.281,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.34,0,0,0,0,1.281,0,0,0,0,1,0,0,0,0,1);
  }
  29.03%{
  box-shadow:0 0 20px rgba(0,0,0,0.3);
    -webkit-transform:matrix3d(1.319,0,0,0,0,1.269,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.319,0,0,0,0,1.269,0,0,0,0,1,0,0,0,0,1);
  }
  29.93%{
    -webkit-transform:matrix3d(1.314,0,0,0,0,1.27,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.314,0,0,0,0,1.27,0,0,0,0,1,0,0,0,0,1);
  }
  35.54%{
    -webkit-transform:matrix3d(1.294,0,0,0,0,1.289,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.294,0,0,0,0,1.289,0,0,0,0,1,0,0,0,0,1);
  }
  36.74%{
    -webkit-transform:matrix3d(1.291,0,0,0,0,1.294,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.291,0,0,0,0,1.294,0,0,0,0,1,0,0,0,0,1);
  }
  41.04%{
    -webkit-transform:matrix3d(1.288,0,0,0,0,1.307,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.288,0,0,0,0,1.307,0,0,0,0,1,0,0,0,0,1);
  }
  44.44%{
    -webkit-transform:matrix3d(1.29,0,0,0,0,1.31,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.29,0,0,0,0,1.31,0,0,0,0,1,0,0,0,0,1);
  }
  52.15%{
    -webkit-transform:matrix3d(1.297,0,0,0,0,1.302,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.297,0,0,0,0,1.302,0,0,0,0,1,0,0,0,0,1);
  }
  59.86%{
    -webkit-transform:matrix3d(1.302,0,0,0,0,1.297,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.302,0,0,0,0,1.297,0,0,0,0,1,0,0,0,0,1);
  }
  63.26%{
    -webkit-transform:matrix3d(1.302,0,0,0,0,1.298,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.302,0,0,0,0,1.298,0,0,0,0,1,0,0,0,0,1);
  }
  75.28%{
    -webkit-transform:matrix3d(1.3,0,0,0,0,1.301,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.3,0,0,0,0,1.301,0,0,0,0,1,0,0,0,0,1);
  }
  85.49%{
    -webkit-transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
  }
  90.69%{
    -webkit-transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
  }
  100%{
    box-shadow:0 0 20px rgba(0,0,0,0.3);
    -webkit-transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
  }
}
@-webkit-keyframes animation{
  0%{
    box-shadow:0 0 0 transparent;
    -webkit-transform:matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);
  }
  3.4%{
    -webkit-transform:matrix3d(1.095,0,0,0,0,1.122,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.095,0,0,0,0,1.122,0,0,0,0,1,0,0,0,0,1);
  }
  4.7%{
    -webkit-transform:matrix3d(1.135,0,0,0,0,1.18,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.135,0,0,0,0,1.18,0,0,0,0,1,0,0,0,0,1);
  }
  6.81%{
    -webkit-transform:matrix3d(1.198,0,0,0,0,1.268,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.198,0,0,0,0,1.268,0,0,0,0,1,0,0,0,0,1);
  }
  9.41%{
    -webkit-transform:matrix3d(1.265,0,0,0,0,1.35,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.265,0,0,0,0,1.35,0,0,0,0,1,0,0,0,0,1);
  }
  10.21%{
    -webkit-transform:matrix3d(1.282,0,0,0,0,1.368,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.282,0,0,0,0,1.368,0,0,0,0,1,0,0,0,0,1);
  }
  13.61%{
    -webkit-transform:matrix3d(1.337,0,0,0,0,1.4,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.337,0,0,0,0,1.4,0,0,0,0,1,0,0,0,0,1);
  }
  14.11%{
    -webkit-transform:matrix3d(1.342,0,0,0,0,1.399,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.342,0,0,0,0,1.399,0,0,0,0,1,0,0,0,0,1);
  }
  17.52%{
    -webkit-transform:matrix3d(1.362,0,0,0,0,1.372,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.362,0,0,0,0,1.372,0,0,0,0,1,0,0,0,0,1);
  }
  18.72%{
    -webkit-transform:matrix3d(1.364,0,0,0,0,1.356,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.364,0,0,0,0,1.356,0,0,0,0,1,0,0,0,0,1);
  }
  21.32%{
    -webkit-transform:matrix3d(1.359,0,0,0,0,1.321,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.359,0,0,0,0,1.321,0,0,0,0,1,0,0,0,0,1);
  }
  24.32%{
    -webkit-transform:matrix3d(1.345,0,0,0,0,1.288,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.345,0,0,0,0,1.288,0,0,0,0,1,0,0,0,0,1);
  }
  25.23%{
    -webkit-transform:matrix3d(1.34,0,0,0,0,1.281,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.34,0,0,0,0,1.281,0,0,0,0,1,0,0,0,0,1);
  }
  29.03%{
    box-shadow:0 0 20px rgba(0,0,0,0.3);
    -webkit-transform:matrix3d(1.319,0,0,0,0,1.269,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.319,0,0,0,0,1.269,0,0,0,0,1,0,0,0,0,1);
  }
  29.93%{
    -webkit-transform:matrix3d(1.314,0,0,0,0,1.27,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.314,0,0,0,0,1.27,0,0,0,0,1,0,0,0,0,1);
  }
  35.54%{
    -webkit-transform:matrix3d(1.294,0,0,0,0,1.289,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.294,0,0,0,0,1.289,0,0,0,0,1,0,0,0,0,1);
  }
  36.74%{
    -webkit-transform:matrix3d(1.291,0,0,0,0,1.294,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.291,0,0,0,0,1.294,0,0,0,0,1,0,0,0,0,1);
  }
  41.04%{
    -webkit-transform:matrix3d(1.288,0,0,0,0,1.307,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.288,0,0,0,0,1.307,0,0,0,0,1,0,0,0,0,1);
  }
  44.44%{
    -webkit-transform:matrix3d(1.29,0,0,0,0,1.31,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.29,0,0,0,0,1.31,0,0,0,0,1,0,0,0,0,1);
  }
  52.15%{
    -webkit-transform:matrix3d(1.297,0,0,0,0,1.302,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.297,0,0,0,0,1.302,0,0,0,0,1,0,0,0,0,1);
  }
  59.86%{
    -webkit-transform:matrix3d(1.302,0,0,0,0,1.297,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.302,0,0,0,0,1.297,0,0,0,0,1,0,0,0,0,1);
  }
  63.26%{
    -webkit-transform:matrix3d(1.302,0,0,0,0,1.298,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.302,0,0,0,0,1.298,0,0,0,0,1,0,0,0,0,1);
  }
  75.28%{
    -webkit-transform:matrix3d(1.3,0,0,0,0,1.301,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.3,0,0,0,0,1.301,0,0,0,0,1,0,0,0,0,1);
  }
  85.49%{
    -webkit-transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
  }
  90.69%{
    -webkit-transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
  }
  100%{
    box-shadow:0 0 20px rgba(0,0,0,0.3);
    -webkit-transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
    transform:matrix3d(1.3,0,0,0,0,1.3,0,0,0,0,1,0,0,0,0,1);
  }
}

.drop h2{
  text-transform:uppercase;
  font-size:12px;
  font-weight:700;
  text-align:center;
  
  color:rgb(51,51,51);
}



</style>
<html>
<head>

<title>4x4 | The Fun Word Game</title>

<meta charset="utf-8" />

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<meta content="minimum-scale=1.0, width=device-width, maximum-scale=1, user-scalable=no" name="viewport"/>

<link rel="stylesheet" href="/resources/css/resets.css"/>

<script src='/resources/scripts/util/Overload.min.js'></script>
<script src='/resources/scripts/util/classie.js'></script>
<script src='/resources/scripts/util/Post.js'></script>
<script src='/resources/scripts/util/TrieTree.js'></script>
<script src='/resources/scripts/util/EventDispatcher.js'></script>

<script src='/resources/scripts/Board.js'></script>
<script src='/resources/scripts/Game.js'></script>
<script src='/resources/scripts/Square.js'></script>
<script src='/resources/scripts/SquareDest.js'></script>

</head>
<body>


<div class='header'>
  <div class='menu'></div>
  <div class='timer'>0:00</div>
</div>

<div class='board'></div>

<div class='drop'>
  <h2>dropspace</h2>
</div>


<script type='text/javascript'>
(function(){
  
  function Game(){
    var self = this;
    var undefined;
    
    var board, drop, timer;
    var dict;
    
    var timer_isrunning, timer_start, timer_interval;
    
    self.create = Create;
    
    function CheckPuzzle(){
      if(!IsValidPuzzle()) return;
      
      PauseTimer();
      alert('You Won');
    }
    function IsValidPuzzle(){
      var puzzle = board.getValue(),
          rows = puzzle.map(function(value){return value.join('');}),
          cols = [];
      
      for(var x=0; x<board.getWidth(); x++){
        var col = '';
        for(var y=0; y<board.getHeight(); y++)
          col += puzzle[y][x] || '';
        cols.push(col);
      }
      
      var rows_valid = rows.filter(function(value){return dict.contains(value);}).length == board.getHeight(),
          cols_valid = cols.filter(function(value){return dict.contains(value);}).length == board.getWidth();
      
      return rows_valid && cols_valid;
    }
    
    function GeneratePuzzle(width, height){
      var rows = [], cols = [], used = [];
      
      function Valid(str, len){
        if(str.length == len){
          if(used.indexOf(str) != -1) return false;
          else return dict.contains(str);
        }else{
          var node = dict.get(str);
          return !!node && node.hasChildren();
        }
      }
      
      function Intersect(arr1, arr2){
        return arr1.filter(function(value){
          return arr2.indexOf(value) != -1;
        });
      }
      
      function Recurse(index){
        if(index == width*height) return rows[rows.length-1] != cols[cols.length-1];
        
        var row = Math.floor(index / width),
            col = index - row * width;
        
        if(rows[row] == undefined) rows[row] = '';
        if(cols[col] == undefined) cols[col] = '';
        
        var letters = Intersect(dict.get(rows[row]).getChildren(), dict.get(cols[col]).getChildren());
        while(letters.length > 0){
          var letter = letters.splice(Math.floor(Math.random()*letters.length), 1);
          
          rows[row] += letter;
          cols[col] += letter;
          
          if(Valid(rows[row], width) && Valid(cols[col], height)){
            if(rows[row].length == width) used.push(rows[row]);
            if(cols[col].length == height) used.push(cols[col]);
            if(Recurse(index+1)) return true;
            if(rows[row].length == width) used.splice(-1,1);
            if(cols[col].length == height) used.splice(-1,1);
          }
          
          rows[row] = rows[row].slice(0,-1);
          cols[col] = cols[col].slice(0,-1);
          
        }
        
        return false;
      }
      
      Recurse(0);
      
      var puzzle = [];
      for(var i=0,row; row=rows[i++];) puzzle.push(row.split(''));
      return puzzle;
    }
    
    function Create(width, height){
      board.resize(width, height);
      drop.resize(width, Math.floor(height/2));
      
      var puzzle = GeneratePuzzle(width, height);
      
      var indices = [], sudo_random = [];
      
      for(var y=0; y<board.getHeight(); y++)
        for(var x=0; x<board.getWidth(); x++)
          if(x != y){
            indices.push({x:x, y:y});
          }else{
            if(!sudo_random[y]) sudo_random[y] = [];
            sudo_random[y][x] = puzzle[y].splice(x, 1)[0];
          }
      
      var letters = puzzle.reduce(function(prev, value){return prev.concat(value);});
      while(indices.length > 0){
        var index = indices.splice(Math.floor(Math.random()*indices.length), 1)[0];
        sudo_random[index.y][index.x] = letters.shift();
      }
      
      board.setValue(sudo_random);
      
      var cells = board.getCells();
      for(var y=0; y<board.getHeight(); y++)
        for(var x=0; x<board.getWidth(); x++)
          if(x == y) cells[y][x].getSquare().setMovable(false);
      
      ResetTimer();
      StartTimer();
    }
    
    function StartTimer(){
      if(timer_isrunning) return;
      timer_isrunning = true;
      
      if(timer_start == undefined) timer_start = Date.now();
      timer_interval = setInterval(UpdateTimer, 1000);
    }
    function PauseTimer(){
      if(!timer_isrunning) return;
      timer_isrunning = false;
      
      clearInterval(timer_interval);
    }
    function ResetTimer(){
      timer_start = Date.now();
    }
    function UpdateTimer(){
      var difftime = Date.now() - timer_start,
          hours   = Math.floor((difftime % (60*60*60*1000))/(60*60*1000)),
          minutes = Math.floor((difftime % (   60*60*1000))/(   60*1000)),
          seconds = Math.floor((difftime % (      60*1000))/(      1000));
  
      if(seconds < 10) seconds = '0'+seconds;
      if(hours > 0) if(minutes < 10) minutes = '0'+minutes;
  
      if(hours > 0) timer.innerHTML = hours+':'+minutes+':'+seconds;
      else timer.innerHTML = minutes+':'+seconds;
    }
    
    (function Constructor(dictionary, board_frame, drop_frame, timer_frame){
      dict = dictionary;
      
      board = new Board(board_frame);
      board.addEventListener('snap', CheckPuzzle);
      
      drop = new Board(drop_frame);
      
      timer = timer_frame;
    }).apply(this, arguments);
  }
  
  // pared by me from http://www-01.sil.org/linguistics/wordlists/english/wordlist/wordsEn.txt
  function LoadDictionary(callback){
    var dicts = ['/resources/dict_4.txt'],
        words = [],
        loads = 0;
    
    for(var i=0,dict; dict=dicts[i++];)
      (function(dict){
        Get(dict, function OnResponse(event){
          console.log('Loaded Dict '+(loads+1)+' of '+dicts.length);
        
          words = words.concat(event.responseText.split(','));
          if(++loads == dicts.length) OnFinish();
        });
      })(dict);
    
    function OnFinish(){
      if(typeof callback == 'function') callback(new TrieTree(words));
    }
  }
  
  window.addEventListener('load', Init);
  
  function Init(){
    LoadDictionary(function Callback(dict){
      var game = new Game(
        dict,
        document.querySelector('.board'),
        document.querySelector('.drop'),
        document.querySelector('.timer')
      );
      game.create(4,4);
    });
  }
  
})();
</script>
</body>
</html>
